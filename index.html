<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Permissions Demo</title>
    <style>
        video, img { max-width: 320px; max-height: 240px; }
        #status { color: green; }
        .error { color: red; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Advanced Permissions Demo</h1>
    <p>මෙම පිටුව මයික්, කැමරා, ගැලරි, ස්ථානය, සහ සම්බන්ධතා ප්‍රවේශය ඉල්ලයි.</p>

    <!-- Permissions Section -->
    <div id="permissions-section">
        <button onclick="requestMicAndCam()">Mic & Cam ඉල්ලන්න</button>
        <button onclick="requestGalleryAccess()">Gallery ඉල්ලන්න</button>
        <button onclick="requestLocationAccess()">Location ඉල්ලන්න</button>
        <button onclick="requestContactAccess()">Contacts ඉල්ලන්න</button>
        <button onclick="stopRecording()">Recording නවත්වන්න</button>
    </div>

    <!-- Display Section -->
    <div id="display-section">
        <video id="video" autoplay muted></video>
        <audio id="audio" controls></audio>
        <div id="gallery-output"></div>
        <p id="location-output"></p>
        <ul id="contacts-output"></ul>
        <p id="status"></p>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        let mediaRecorder, audioRecorder, chunks = [];

        // Mic සහ Cam Access
        async function requestMicAndCam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.muted = false;

                // Video Recording
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    chunks = [];
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording_${Date.now()}.webm`;
                    a.click();
                };
                mediaRecorder.start();
                statusElement.textContent = "Mic සහ Cam ප්‍රවේශය ලැබුණා. Recording ආරම්භයි.";

                // Audio Recording (separate for clarity)
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioRecorder = new MediaRecorder(audioStream);
                audioRecorder.ondataavailable = (e) => chunks.push(e.data);
                audioRecorder.onstop = () => {
                    const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                    chunks = [];
                    document.getElementById('audio').src = URL.createObjectURL(audioBlob);
                };
                audioRecorder.start();
            } catch (err) {
                statusElement.textContent = "Mic/Cam ප්‍රවේශය අසාර්ථකයි: " + err.message;
                statusElement.classList.add('error');
            }
        }

        // Recording නවත්වන්න
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                audioRecorder.stop();
                statusElement.textContent = "Recording නතර කළා.";
            }
        }

        // Gallery Access (File Picker Simulation)
        async function requestGalleryAccess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                statusElement.textContent = "Gallery ප්‍රවේශය ලැබුණා (කැමරාවෙන් උදාහරණයක්).";
                const galleryOutput = document.getElementById('gallery-output');
                const img = document.createElement('img');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 320;
                canvas.height = 240;
                ctx.drawImage(document.getElementById('video'), 0, 0, 320, 240);
                img.src = canvas.toDataURL('image/png');
                galleryOutput.appendChild(img);
            } catch (err) {
                statusElement.textContent = "Gallery ප්‍රවේශය අසාර්ථකයි: " + err.message;
                statusElement.classList.add('error');
            }
        }

        // Location Access
        function requestLocationAccess() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        document.getElementById('location-output').textContent = 
                            `ස්ථානය: Latitude ${latitude}, Longitude ${longitude}`;
                        statusElement.textContent = "Location ප්‍රවේශය ලැබුණා.";
                    },
                    (err) => {
                        statusElement.textContent = "Location ප්‍රවේශය අසාර්ථකයි: " + err.message;
                        statusElement.classList.add('error');
                    }
                );
            } else {
                statusElement.textContent = "Geolocation මෙම බ්‍රවුසරයේ නැත.";
            }
        }

        // Contact Access
        async function requestContactAccess() {
            if ('contacts' in navigator && 'select' in navigator.contacts) {
                try {
                    const contacts = await navigator.contacts.select(['name', 'email', 'tel'], { multiple: true });
                    const contactsOutput = document.getElementById('contacts-output');
                    contacts.forEach(contact => {
                        const li = document.createElement('li');
                        li.textContent = `${contact.name} - ${contact.email || ''} - ${contact.tel || ''}`;
                        contactsOutput.appendChild(li);
                    });
                    statusElement.textContent = "Contacts ප්‍රවේශය ලැබුණා.";
                } catch (err) {
                    statusElement.textContent = "Contacts ප්‍රවේශය අසාර්ථකයි: " + err.message;
                    statusElement.classList.add('error');
                }
            } else {
                statusElement.textContent = "Contacts API මෙම බ්‍රවුසරයේ නැත.";
            }
        }
    </script>
</body>
</html>